---
import { promos } from "../../data/promos";
import { getLangFromUrl, useTranslations } from "../../i18n/utils";
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<!-- PROMO CARDS SECTION -->
<section class="py-16 px-4">
  <div class="max-w-7xl mx-auto">
    <!-- Section Header -->
    <div class="text-center mb-12">
      <div
        class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-orange-500/10 to-green-500/10 rounded-full border border-orange-200/50 backdrop-blur-sm mb-4">
        <svg
          class="w-5 h-5 text-orange-500"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"
          ></path>
        </svg>
        <span
          class="text-sm font-medium bg-gradient-to-r from-orange-600 to-green-600 bg-clip-text text-transparent">
          {t("promo.badge")}
        </span>
      </div>

      <h2 class="text-4xl md:text-5xl font-bold mb-4">
        <span
          class="bg-gradient-to-r from-orange-600 to-green-600 bg-clip-text text-transparent">
          {t("promo.title")}
        </span>
      </h2>
      <p class="text-lg max-w-2xl mx-auto" style="color: var(--text-muted);">
        {t("promo.subtitle")}
      </p>
    </div>

    <!-- Promo Carousel Container -->
    <div class="relative">
      <!-- Navigation Buttons -->
      <button
        id="prevPromo"
        class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 z-20 w-12 h-12 rounded-full shadow-lg flex items-center justify-center transition-all duration-300 hover:scale-110 md:flex hidden"
        style="background-color: var(--background-body); border: 2px solid color-mix(in srgb, var(--text-muted) 20%, transparent);">
        <svg
          class="w-6 h-6"
          style="color: var(--text-main);"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>

      <button
        id="nextPromo"
        class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 z-20 w-12 h-12 rounded-full shadow-lg flex items-center justify-center transition-all duration-300 hover:scale-110 md:flex hidden"
        style="background-color: var(--background-body); border: 2px solid color-mix(in srgb, var(--text-muted) 20%, transparent);">
        <svg
          class="w-6 h-6"
          style="color: var(--text-main);"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 5l7 7-7 7"></path>
        </svg>
      </button>

      <!-- Promo Cards Carousel -->
      <div class="overflow-hidden">
        <div
          id="promoTrack"
          class="flex gap-6 transition-transform duration-500 ease-out">
          {
            (promos && promos.length > 0
              ? promos
              : Array.from({ length: 3 }, () => ({
                  badge: "COMING SOON",
                  badgeColor: "orange",
                  title: "Segera Hadir",
                  description: "Promo spesial sedang kami siapkan untuk Anda",
                  price: "-",
                  oldPrice: null,
                  note: null,
                  features: ["Informasi akan segera diumumkan"],
                  link: "#",
                  buttonText: "Segera Hadir",
                  image: null,
                }))
            ).map((promo) => (
              <div
                class="promo-card flex-shrink-0 w-full md:w-[calc(50%-12px)] lg:w-[calc(33.333%-16px)] group relative rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 border"
                style="background-color: var(--background-body); border-color: color-mix(in srgb, var(--text-muted) 15%, transparent);">
                {/* Image Section */}
                {promo.image && (
                  <div class="relative h-48 overflow-hidden">
                    <img
                      src={promo.image}
                      alt={promo.title}
                      class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                    />
                    <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent" />
                  </div>
                )}

                {/* Badge */}
                <div
                  class={`absolute ${promo.image ? "top-4" : "top-4"} right-4 z-10`}>
                  <div
                    class={`px-3 py-1.5 md:px-4 md:py-2 rounded-full font-bold text-xs md:text-sm shadow-lg text-white ${
                      promo.badgeColor === "orange"
                        ? "bg-gradient-to-r from-orange-500 to-orange-600"
                        : "bg-gradient-to-r from-green-500 to-green-600"
                    }`}>
                    {promo.badge}
                  </div>
                </div>

                <div
                  class={`p-6 relative z-10 ${promo.image ? "pt-4" : "pt-16"}`}>
                  {/* Title & Description */}
                  <h3
                    class="text-xl font-bold mb-2"
                    style="color: var(--text-main);">
                    {promo.title}
                  </h3>

                  <p
                    class="mb-4 text-sm leading-relaxed"
                    style="color: var(--text-muted);">
                    {promo.description}
                  </p>

                  {/* Price Section */}
                  <div
                    class="mb-4 pb-4 border-b"
                    style="border-color: color-mix(in srgb, var(--text-muted) 15%, transparent);">
                    <div class="flex items-baseline gap-2 flex-wrap">
                      <span class="text-3xl font-bold bg-gradient-to-r from-orange-600 to-orange-500 bg-clip-text text-transparent">
                        {promo.price}
                      </span>
                      {promo.oldPrice && (
                        <span
                          class="text-base line-through opacity-50"
                          style="color: var(--text-muted);">
                          {promo.oldPrice}
                        </span>
                      )}
                    </div>
                    {promo.note && (
                      <p class="text-xs mt-1" style="color: var(--text-muted);">
                        {promo.note}
                      </p>
                    )}
                  </div>

                  {/* Features List */}
                  <ul class="space-y-2 mb-6">
                    {promo.features.slice(0, 3).map((feature) => (
                      <li class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-4 h-4 rounded-full bg-green-500/10 flex items-center justify-center mt-0.5">
                          <svg
                            class="w-2.5 h-2.5 text-green-500"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="3"
                              d="M5 13l4 4L19 7"
                            />
                          </svg>
                        </div>
                        <span
                          class="text-xs leading-relaxed"
                          style="color: var(--text-muted);">
                          {feature}
                        </span>
                      </li>
                    ))}
                    {promo.features.length > 3 && (
                      <li
                        class="text-xs ml-6"
                        style="color: var(--text-muted);">
                        +{promo.features.length - 3} lainnya
                      </li>
                    )}
                  </ul>

                  {/* CTA Button */}
                  <a
                    href={promo.link}
                    class={`block text-center px-6 py-2.5 rounded-xl font-semibold transition-all duration-300 text-sm ${
                      promo.badgeColor === "orange"
                        ? "btn-primary-pec"
                        : "btn-secondary-pec"
                    }`}>
                    {promo.buttonText}
                    <svg
                      class="inline-block w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M13 7l5 5m0 0l-5 5m5-5H6"
                      />
                    </svg>
                  </a>
                </div>

                {/* Bottom Decoration */}
                <div
                  class="absolute bottom-0 left-0 right-0 h-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                  style={`background: linear-gradient(to right, ${
                    promo.badgeColor === "orange"
                      ? "#f97316, #ea580c"
                      : "#16a34a, #15803d"
                  });`}
                />
              </div>
            ))
          }
        </div>
      </div>

      {/* Dots Indicator */}
      <div id="promoDotsContainer" class="flex justify-center gap-2 mt-8">
        <!-- Dots will be generated by JS -->
      </div>
    </div>
  </div>
</section>

<style>
  .promo-card {
    transition:
      transform 0.3s ease,
      box-shadow 0.3s ease;
  }

  .promo-card:hover {
    transform: translateY(-4px);
  }
</style>

<script>
  function initPromoCarousel() {
    const track = document.getElementById("promoTrack");
    const prevBtn = document.getElementById("prevPromo");
    const nextBtn = document.getElementById("nextPromo");
    const dotsContainer = document.getElementById("promoDotsContainer");

    if (!track || !prevBtn || !nextBtn || !dotsContainer) return;

    const cards = track.querySelectorAll(".promo-card");
    let currentIndex = 0;
    let itemsPerView = 3;

    // Calculate items per view based on screen size
    function updateItemsPerView() {
      if (window.innerWidth < 768) {
        itemsPerView = 1;
      } else if (window.innerWidth < 1024) {
        itemsPerView = 2;
      } else {
        itemsPerView = 3;
      }
    }

    const totalPages = Math.ceil(cards.length / itemsPerView);

    // Create dots
    function createDots() {
      dotsContainer.innerHTML = "";
      for (let i = 0; i < totalPages; i++) {
        const dot = document.createElement("button");
        dot.className = "w-2 h-2 rounded-full transition-all duration-300";
        dot.style.backgroundColor =
          i === currentIndex
            ? "var(--text-primary)"
            : "color-mix(in srgb, var(--text-muted) 30%, transparent)";
        dot.addEventListener("click", () => goToSlide(i));
        dotsContainer.appendChild(dot);
      }
    }

    function updateDots() {
      const dots = dotsContainer.querySelectorAll("button");
      dots.forEach((dot, i) => {
        dot.style.backgroundColor =
          i === currentIndex
            ? "var(--text-primary)"
            : "color-mix(in srgb, var(--text-muted) 30%, transparent)";
        dot.style.width = i === currentIndex ? "2rem" : "0.5rem";
      });
    }

    function goToSlide(index) {
      currentIndex = Math.max(0, Math.min(index, totalPages - 1));
      const firstCard = cards[0] as HTMLElement;
      const cardWidth = firstCard.offsetWidth;
      const gap = 24; // 1.5rem = 24px
      const offset =
        currentIndex *
        (cardWidth * itemsPerView + gap * (itemsPerView - 1) + gap);
      track.style.transform = `translateX(-${offset}px)`;
      updateDots();
    }

    prevBtn.addEventListener("click", () => {
      goToSlide(currentIndex - 1);
    });

    nextBtn.addEventListener("click", () => {
      goToSlide(currentIndex + 1);
    });

    // Touch support for mobile
    let touchStartX = 0;
    let touchEndX = 0;

    track.addEventListener("touchstart", (e) => {
      touchStartX = e.changedTouches[0].screenX;
    });

    track.addEventListener("touchend", (e) => {
      touchEndX = e.changedTouches[0].screenX;
      if (touchStartX - touchEndX > 50) {
        goToSlide(currentIndex + 1);
      } else if (touchEndX - touchStartX > 50) {
        goToSlide(currentIndex - 1);
      }
    });

    // Resize handler
    window.addEventListener("resize", () => {
      updateItemsPerView();
      createDots();
      goToSlide(0);
    });

    // Initialize
    updateItemsPerView();
    createDots();
    goToSlide(0);
  }

  // Run on initial load
  initPromoCarousel();

  // Run after view transitions
  document.addEventListener("astro:page-load", initPromoCarousel);
  document.addEventListener("DOMContentLoaded", initPromoCarousel);
</script>
