---
import { getRouteUrl } from "../../i18n/path";
import { routes, type RouteKey } from "../../i18n/routes";
import { defaultLang, type Language } from "../../i18n/ui"; // Pastikan path ini benar sesuai struktur folder Anda

interface Props {
  currentLocale: string;
}

const { currentLocale } = Astro.props;
const currentPath = Astro.url.pathname;

const languages = [
  { code: "id", name: "Indonesia", flag: "ðŸ‡®ðŸ‡©", native: "Bahasa Indonesia" },
  { code: "en", name: "English", flag: "ðŸ‡¬ðŸ‡§", native: "English" },
  { code: "ar", name: "Arabic", flag: "ðŸ‡¸ðŸ‡¦", native: "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©" },
];

const currentLanguage =
  languages.find((l) => l.code === currentLocale) || languages[0];

const isRTL = currentLocale === "ar";

/**
 * Fungsi untuk mencari RouteKey (misal: 'about', 'services')
 * berdasarkan URL saat ini dan bahasa saat ini.
 */
function getCurrentRouteKey(
  path: string,
  locale: string,
): RouteKey | undefined {
  let cleanPath = path.replace(/\/$/, "");

  if (locale !== defaultLang) {
    cleanPath = cleanPath.replace(new RegExp(`^/${locale}`), "");
  }

  // âœ… Ambil segment pertama saja (ignore slug dinamis seperti /katarak)
  const firstSegment = cleanPath.replace(/^\//, "").split("/")[0];

  for (const [key, translations] of Object.entries(routes)) {
    if (translations[locale as Language] === firstSegment) {
      return key as RouteKey;
    }
  }

  return undefined;
}

const routeKey = getCurrentRouteKey(currentPath, currentLocale);

/**
 * Fungsi Helper untuk generate href
 * Jika routeKey ketemu (halaman statis), pakai getRouteUrl.
 * Jika tidak (halaman dinamis misal blog detail), lakukan replace manual.
 */
function getHref(targetLang: string) {
  if (routeKey) {
    const baseUrl = getRouteUrl(targetLang as Language, routeKey);

    // Ambil segments setelah route utama (misal: /katarak dari /layanan/katarak)
    let cleanPath = currentPath.replace(/\/$/, "");
    if (currentLocale !== defaultLang) {
      cleanPath = cleanPath.replace(new RegExp(`^/${currentLocale}`), "");
    }
    const segments = cleanPath.replace(/^\//, "").split("/");
    const dynamicSegments = segments.slice(1); // hapus segment pertama (nama route)

    // Gabungkan base URL + dynamic segments
    if (dynamicSegments.length > 0) {
      return `${baseUrl}/${dynamicSegments.join("/")}`;
    }
    return baseUrl;
  }

  // Fallback (tidak berubah)
  let pathWithoutLang = currentPath;
  if (currentLocale !== defaultLang) {
    pathWithoutLang = currentPath.replace(`/${currentLocale}`, "") || "/";
  }

  if (targetLang === defaultLang) {
    return pathWithoutLang;
  }
  return `/${targetLang}${pathWithoutLang === "/" ? "" : pathWithoutLang}`;
}
---

<div
  class={`language-dropdown ${isRTL ? "rtl" : ""}`}
  dir={isRTL ? "rtl" : "ltr"}>
  <button
    id="lang-dropdown-btn"
    class="lang-toggle-btn"
    aria-label="Select language"
    aria-expanded="false"
    aria-controls="lang-dropdown-menu"
    type="button">
    <span class="flag">{currentLanguage.flag}</span>
    <span class="lang-code">{currentLanguage.code.toUpperCase()}</span>

    <svg
      class="dropdown-arrow"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      width="16"
      height="16">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M19 9l-7 7-7-7"></path>
    </svg>
  </button>

  <div id="lang-dropdown-menu" class="lang-dropdown-menu" role="menu" hidden>
    {
      languages.map((lang) => (
        <a
          href={getHref(lang.code)}
          data-lang={lang.code}
          class={`lang-option ${lang.code === currentLocale ? "active" : ""}`}
          role="menuitem">
          <div class="lang-option-content">
            <span class="lang-flag">{lang.flag}</span>

            <div class="lang-info">
              <div class="lang-native">{lang.native}</div>
              <div class="lang-name">{lang.name}</div>
            </div>

            {lang.code === currentLocale && (
              <svg
                class="check-icon"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                width="20"
                height="20">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 13l4 4L19 7"
                />
              </svg>
            )}
          </div>
        </a>
      ))
    }
  </div>
</div>

<script is:inline>
  function initLanguageDropdown() {
    const dropdownBtn = document.getElementById("lang-dropdown-btn");
    const dropdownMenu = document.getElementById("lang-dropdown-menu");
    const langOptions = document.querySelectorAll(".lang-option");

    if (!dropdownBtn || !dropdownMenu) return;

    const dropdownArrow = dropdownBtn.querySelector(".dropdown-arrow");
    let isOpen = false;

    function toggleDropdown(e) {
      if (e) e.stopPropagation();
      isOpen = !isOpen;

      if (isOpen) {
        dropdownMenu.removeAttribute("hidden");
        dropdownMenu.classList.add("open");
        dropdownBtn.setAttribute("aria-expanded", "true");
        dropdownArrow?.classList.add("rotate");
      } else {
        dropdownMenu.classList.remove("open");
        dropdownBtn.setAttribute("aria-expanded", "false");
        dropdownArrow?.classList.remove("rotate");

        setTimeout(() => {
          if (!isOpen) dropdownMenu.setAttribute("hidden", "");
        }, 300);
      }
    }

    function closeDropdown() {
      if (isOpen) toggleDropdown();
    }

    dropdownBtn.addEventListener("click", toggleDropdown);

    document.addEventListener("click", (e) => {
      if (!dropdownBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
        closeDropdown();
      }
    });

    langOptions.forEach((option) => {
      option.addEventListener("click", function () {
        const selectedLang = this.getAttribute("data-lang");
        if (selectedLang) {
          localStorage.setItem("preferredLanguage", selectedLang);
        }
        closeDropdown();
      });
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeDropdown();
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initLanguageDropdown);
  } else {
    initLanguageDropdown();
  }

  document.addEventListener("astro:after-swap", initLanguageDropdown);
</script>

<style>
  .language-dropdown {
    position: relative;
    display: inline-block;
    margin-left: 10px;
  }

  .lang-toggle-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    background-color: var(--background-body);
    border: 2px solid var(--text-secondary);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 600;
  }

  .lang-toggle-btn:hover {
    border-color: var(--text-primary);
    transform: translateY(-1px);
  }

  .flag {
    font-size: 18px;
  }

  .lang-code {
    font-size: 13px;
    color: var(--text-main);
  }

  .dropdown-arrow {
    transition: transform 0.3s ease;
    opacity: 0.7;
  }

  .dropdown-arrow.rotate {
    transform: rotate(180deg);
  }

  .lang-dropdown-menu {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    width: 220px;
    background-color: var(--background-body);
    border: 2px solid var(--text-secondary);
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    opacity: 0;
    transform: translateY(-10px);
    pointer-events: none;
    transition: all 0.3s ease;
    z-index: 1000;
  }

  .lang-dropdown-menu.open {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .lang-option {
    display: block;
    padding: 12px 16px;
    text-decoration: none;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }

  .lang-option:hover {
    background-color: var(--text-primary);
  }

  .lang-option:hover * {
    color: white;
  }

  .lang-option.active {
    background-color: rgba(22, 163, 74, 0.1);
  }

  .lang-option-content {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .lang-flag {
    font-size: 24px;
  }

  .lang-info {
    flex: 1;
  }

  .lang-native {
    font-weight: 600;
  }

  .lang-name {
    font-size: 11px;
    opacity: 0.7;
  }

  .check-icon {
    flex-shrink: 0;
  }

  /* =====================
     RTL (Arabic) Support
  ===================== */
  .language-dropdown.rtl {
    direction: rtl;
  }

  .language-dropdown.rtl .lang-toggle-btn {
    flex-direction: row-reverse;
  }

  .language-dropdown.rtl .lang-dropdown-menu {
    right: auto;
    left: 0;
  }

  .language-dropdown.rtl .lang-option-content {
    flex-direction: row-reverse;
    text-align: right;
  }

  .language-dropdown.rtl .lang-info {
    text-align: right;
  }

  .language-dropdown.rtl .check-icon {
    margin-right: 8px;
    margin-left: 0;
  }

  @media (max-width: 520px) {
    .lang-code {
      display: none;
    }
  }
</style>
