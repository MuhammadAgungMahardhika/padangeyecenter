---
// src/components/LanguageDropdown.astro
import { getRelativeLocaleUrl } from "astro:i18n";

interface Props {
  currentLocale: string;
}

const { currentLocale } = Astro.props;

// Get current path without locale
const currentPath = Astro.url.pathname.replace(/^\/(id|en)/, "") || "/";

const languages = [
  { code: "id", name: "Indonesia", flag: "ðŸ‡®ðŸ‡©", native: "Bahasa Indonesia" },
  { code: "en", name: "English", flag: "ðŸ‡¬ðŸ‡§", native: "English" },
];

const currentLanguage =
  languages.find((l) => l.code === currentLocale) || languages[0];
---

<!-- Language Dropdown -->
<div class="language-dropdown">
  <button
    id="lang-dropdown-btn"
    class="lang-toggle-btn"
    aria-label="Select language"
    aria-expanded="false"
    aria-controls="lang-dropdown-menu"
    type="button">
    <span class="flag">{currentLanguage.flag}</span>
    <span class="lang-code">
      {currentLanguage.code.toUpperCase()}
    </span>
    <svg
      class="dropdown-arrow"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      width="16"
      height="16">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M19 9l-7 7-7-7"></path>
    </svg>
  </button>

  <!-- Dropdown Menu - Remove aria-hidden, use hidden attribute instead -->
  <div id="lang-dropdown-menu" class="lang-dropdown-menu" role="menu" hidden>
    {
      languages.map((lang) => (
        <a
          href={getRelativeLocaleUrl(lang.code, currentPath)}
          data-lang={lang.code}
          class={`lang-option ${lang.code === currentLocale ? "active" : ""}`}
          role="menuitem">
          <div class="lang-option-content">
            <span class="lang-flag">{lang.flag}</span>
            <div class="lang-info">
              <div class="lang-native">{lang.native}</div>
              <div class="lang-name">{lang.name}</div>
            </div>
            {lang.code === currentLocale && (
              <svg
                class="check-icon"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                width="20"
                height="20">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 13l4 4L19 7"
                />
              </svg>
            )}
          </div>
        </a>
      ))
    }
  </div>
</div>

<script is:inline>
  // Initialize dropdown functionality
  function initLanguageDropdown() {
    const dropdownBtn = document.getElementById("lang-dropdown-btn");
    const dropdownMenu = document.getElementById("lang-dropdown-menu");
    const langOptions = document.querySelectorAll(".lang-option");

    if (!dropdownBtn || !dropdownMenu) return;

    const dropdownArrow = dropdownBtn.querySelector(".dropdown-arrow");
    let isOpen = false;

    function toggleDropdown(e) {
      if (e) e.stopPropagation();
      isOpen = !isOpen;

      if (isOpen) {
        dropdownMenu.removeAttribute("hidden");
        dropdownMenu.classList.add("open");
        dropdownBtn.setAttribute("aria-expanded", "true");
        if (dropdownArrow) dropdownArrow.classList.add("rotate");
      } else {
        dropdownMenu.classList.remove("open");
        dropdownBtn.setAttribute("aria-expanded", "false");
        if (dropdownArrow) dropdownArrow.classList.remove("rotate");

        // Wait for animation to finish before hiding
        setTimeout(function () {
          if (!isOpen) {
            dropdownMenu.setAttribute("hidden", "");
          }
        }, 300);
      }
    }

    function closeDropdown() {
      if (isOpen) {
        toggleDropdown();
      }
    }

    // Button click
    dropdownBtn.addEventListener("click", toggleDropdown);

    // Close when clicking outside
    document.addEventListener("click", function (e) {
      if (!dropdownBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
        closeDropdown();
      }
    });

    // Save language preference when clicked
    langOptions.forEach(function (option) {
      option.addEventListener("click", function () {
        const selectedLang = this.getAttribute("data-lang");
        if (selectedLang) {
          localStorage.setItem("preferredLanguage", selectedLang);
        }
        closeDropdown();
      });
    });

    // Close on Escape key
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape") {
        closeDropdown();
      }
    });
  }

  // Run on page load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initLanguageDropdown);
  } else {
    initLanguageDropdown();
  }

  // Re-run after navigation (for view transitions)
  document.addEventListener("astro:after-swap", initLanguageDropdown);
</script>

<style>
  .language-dropdown {
    position: relative;
    display: inline-block;
    margin-left: 10px;
  }

  .lang-toggle-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    background-color: var(--background-body);
    border: 2px solid var(--text-secondary);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: var(--font-family-sans);
    font-weight: 600;
  }

  .lang-toggle-btn:hover {
    border-color: var(--text-primary);
    transform: translateY(-1px);
  }

  .flag {
    font-size: 18px;
    line-height: 1;
  }

  .lang-code {
    font-size: 13px;
    color: var(--text-main);
    text-transform: uppercase;
  }

  .dropdown-arrow {
    transition: transform 0.3s ease;
    color: var(--text-main);
    opacity: 0.7;
  }

  .dropdown-arrow.rotate {
    transform: rotate(180deg);
  }

  /* Dropdown Menu */
  .lang-dropdown-menu {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    width: 220px;
    background-color: var(--background-body);
    border: 2px solid var(--text-secondary);
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    overflow: hidden;
    opacity: 0;
    transform: translateY(-10px);
    transition:
      opacity 0.3s ease,
      transform 0.3s ease;
    pointer-events: none;
  }

  /* Show dropdown when not hidden */
  .lang-dropdown-menu:not([hidden]) {
    display: block;
  }

  .lang-dropdown-menu.open {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .lang-option {
    display: block;
    width: 100%;
    padding: 12px 16px;
    text-decoration: none;
    transition: background-color 0.2s ease;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    cursor: pointer;
  }

  :root.theme-dark .lang-option {
    border-bottom-color: rgba(255, 255, 255, 0.05);
  }

  .lang-option:last-child {
    border-bottom: none;
  }

  .lang-option:hover {
    background-color: var(--text-primary);
  }

  .lang-option:hover .lang-native,
  .lang-option:hover .lang-name,
  .lang-option:hover .check-icon {
    color: white;
  }

  .lang-option.active {
    background-color: rgba(22, 163, 74, 0.1);
  }

  :root.theme-dark .lang-option.active {
    background-color: rgba(22, 163, 74, 0.2);
  }

  .lang-option-content {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .lang-flag {
    font-size: 24px;
    line-height: 1;
  }

  .lang-info {
    flex: 1;
    text-align: left;
  }

  .lang-native {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-main);
    line-height: 1.3;
  }

  .lang-name {
    font-size: 11px;
    color: var(--text-secondary);
    opacity: 0.7;
    line-height: 1.3;
  }

  .check-icon {
    color: var(--text-secondary);
    flex-shrink: 0;
  }

  /* Responsive */
  @media screen and (max-width: 520px) {
    .language-dropdown {
      margin-left: 5px;
    }

    .lang-toggle-btn {
      padding: 6px 10px;
    }

    .lang-code {
      display: none;
    }

    .lang-dropdown-menu {
      width: 200px;
    }
  }
</style>
